<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VCF Validator: Developer guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">VCF Validator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/dec/md_docs_2developer-guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Developer guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md4"></a> This page explains how the project is structured and hopefully gives a quick tour so that any new developer understands how to make and deploy any maintenance or new features. However, this mostly provides understanding; for a practical guide to get the project compiled see the <a class="el" href="../../d3/dcc/md__r_e_a_d_m_e.html">README.md</a>.</p>
<p>This page tries to start explaining from less-technical higher level and go down into the programming technical details.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Build process overview</h1>
<p>This is a C++ project that produces 3 binaries: vcf-validator, vcf-assembly-checker and vcf-debugulator. The build is done with CMake (file <a href="../../../CMakeLists.txt">CMakeLists.txt</a>) for Linux, Windows and macOS. There are scripts to help installing the dependencies (<a href="../../../install_dependencies.sh">install_dependencies.sh</a>) for Linux and macOS, and <a href="../../../install_dependencies.bat">install_dependencies.bat</a> for Windows).</p>
<p>We also use TravisCI (<a href="../../../.travis.yml">.travis.yml</a>) and AppVeyor (<a href="../../../appveyor.yml">appveyor.yml</a>) to do builds and run tests on Pull Requests and to generate the binaries from tags in master that we upload to the releases page (<a href="https://github.com/EBIvariation/vcf-validator/releases">https://github.com/EBIvariation/vcf-validator/releases</a>).</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Deploying</h2>
<p>Once we tag a commit in master and push the tag, travis will generate binaries for Linux and macOs, and AppVeyor will generate the Windows ones.</p>
<p>The process is semi-automatic at the moment of writing. Travis will prepare a new Releases page with no description but will upload the binaries. The manual step is to download the Windows binaries from AppVeyor and upload to that page, and also fill the release notes.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Compilation architecture</h1>
<p>This image is a summary of the compilation process from source code to executable binaries:</p>
<p><img src="../../img/VCF-validator-architecture.png" alt="architecture image" class="inline"/></p>
<p>In case of dependent libraries being installed in non-standard paths, update LIBRARY_PATH as shown below 'export LIBRARY_PATH=$LIBRARY_PATH:&lt;path to required library's libpath&gt;'</p>
<p>The role of Ragel and ODB in this project is explained further below.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Code structure</h1>
<p>As opposed to java projects where interfaces and implementations are often put in the same packages, it's not uncommon in C and C++ to separate headers (.hpp) and implementation (.cpp) files. In this project the headers are in <a href="../../../inc/"><code>inc/</code></a> and the implementation in <a href="../../../src/"><code>src/</code></a>. Both the tests source code and the test data is in <a href="../../../test/"><code>test/</code></a>.</p>
<p>Java packages are roughly equivalent to C++ namespaces. However, in C++ the namespaces and the folders do not need to match. In this project we use different namespaces (and matching folders) for different topics: vcf, fasta, assembly_report, util.</p>
<p>The programs' entry points (the <code>main()</code>s) are <a href="../../../src/validator_main.cpp">src/validator_main.cpp</a>, <a href="../../../src/assembly_checker_main.cpp">src/assembly_checker_main.cpp</a> and <a href="../../../src/debugulator_main.cpp">src/debugulator_main.cpp</a>.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Features' location</h1>
<p>If you need to change something in this project you need to understand what features there are, and where are they implemented.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
VCF Validator features</h2>
<p>The VCF Validator is the main program of this project and it performs syntax and semantic checks on a given (possibly compressed) VCF.</p>
<p>After parsing the input VCF, the semantic checks are performed on a C++ model of VCF (including the metadata section), and <code>Error</code> classes (related among themselves by hierarchical inheritance) are used to represent different types of possible errors.</p>
<p>Based on those <code>Error</code>s, the program can produce human-readable reports and a machine-readable report that the VCF Debugulator can read to fix some basic errors.</p>
<p>The level of checks can be configured, from doing just a quick syntax check, to raise warnings of suspicious details.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Compression</h3>
<p>A tricky but not complex step is to decompress on the fly the VCF if needed. See <a href="../../../inc/vcf/compression.hpp">inc/vcf/compression.hpp</a>.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Syntax checks - Ragel</h3>
<p><a href="http://www.colm.net/open-source/ragel/">Ragel</a> is a library to create regex-powered parsers. In a language similar to <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form">BNF</a>, we have defined the grammar of VCF.</p>
<p>The common and basic definitions are in <a href="../../../src/vcf/vcf.ragel">src/vcf/vcf.ragel</a>, and then the parts that differ between versions are defined in <a href="../../../src/vcf/vcf_v41.ragel">src/vcf/vcf_v41.ragel</a>, <a href="../../../src/vcf/vcf_v41.ragel">src/vcf/vcf_v41.ragel</a> and <a href="../../../src/vcf/vcf_v41.ragel">src/vcf/vcf_v41.ragel</a>.</p>
<p>Those files not only describe the regex that define the syntax, they also define the points of the grammar where the semantic checks are injected.</p>
<p>Those files are transpiled with Ragel into C code with the next commands: </p><div class="fragment"><div class="line">ragel -G2 src/vcf/vcf_v41.ragel -o inc/vcf/validator_detail_v41.hpp</div>
<div class="line">ragel -G2 src/vcf/vcf_v42.ragel -o inc/vcf/validator_detail_v42.hpp</div>
<div class="line">ragel -G2 src/vcf/vcf_v43.ragel -o inc/vcf/validator_detail_v43.hpp</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md13"></a>
VCF parsing, policies and file structure</h3>
<p>Now, we have the generated code by ragel that parses the VCF, but how is that code called if we start at <code>main()</code>?</p>
<p>At the end of the src/vcf/vcf_v*.ragel files we tell Ragel to put the parser as implementation of the ParserImpl class, which is defined in <a href="../../../inc/vcf/validator.hpp">inc/vcf/validator.hpp</a>. In that file we declare the parsing classes, some functions to kickstart the parsing, and the plugging of the policies into the parsers.</p>
<p>After Ragel has parsed each VCF line, the policies are the way to configure the Parser classes for the level of semantic checks:</p>
<ul>
<li><a href="../../../inc/vcf/parse_policy.hpp">inc/vcf/parse_policy.hpp</a> declares the policy of either storing the result of parsing into the VCF C++ model, or just forget the data if the user only wants to check syntax. The model for each VCF line is a MetaEntry or a Record (defined in <a href="../../../inc/vcf/file_structure.hpp">inc/vcf/file_structure.hpp</a>).</li>
<li><a href="../../../inc/vcf/optional_policy.hpp">inc/vcf/optional_policy.hpp</a> declares the policy of whether to check also for warnings, or just errors. Warnings usually flag weird things that are compliant with the spec but that you wouldn't expect from a reasonable VCF.</li>
<li><a href="../../../inc/vcf/error_policy.hpp">inc/vcf/error_policy.hpp</a> declares the policy to stop on the first error, or read the whole VCF and produce a report.</li>
</ul>
<h3><a class="anchor" id="autotoc_md14"></a>
Semantic checks</h3>
<p>Once we have a Record containing the information of a line (chromosome, position, alleles, INFO and GT columns, etc.), some more functions are called to check the consistency of the data, also in relation to the definitions in the metadata section of the VCF.</p>
<p>Some of these functions are part of the policies. For instance, the check that each sample only appears once and the check that the contigs and positions are sorted are both implemented in <a href="../../../src/vcf/store_parse_policy.cpp">src/vcf/store_parse_policy.cpp</a>. The semantic checks that are warnings are implemented in <a href="../../../src/vcf/validate_optional_policy.cpp">src/vcf/validate_optional_policy.cpp</a>.</p>
<p>A notable exception is the check for duplicate variants, which, for pragmatic reasons, was done in vcf.ragel (search <code>action record_end {</code>). The check for duplicate variants uses a <a href="../../../inc/vcf/record_cache.hpp">RecordCache</a> to compare nearby variants, and this in turn uses a naive <a href="../../../inc/vcf/normalizer.hpp">normalizer</a> that removes redundant context bases from the alleles and tweaks the position accordingly, but doesn't do full realignment using the reference sequence.</p>
<h3><a class="anchor" id="autotoc_md15"></a>
Reporting</h3>
<p>Once an error or a warning is detected, an exception is thrown from the appropiate class in <a href="../../../inc/vcf/Error.hpp">inc/vcf/Error.hpp</a>. We take advantage of polymorphism when we catch those exceptions in vcf.ragel (again, search for <code>action record_end</code>).</p>
<p>If the policy to report the errors is in use, the parser has the list of report writers the user requested. These can be any combination of <a href="../../../inc/vcf/record.hpp">simple report</a>, <a href="../../../inc/vcf/summary_report_writer.hpp">summary report</a>, and <a href="../../../inc/vcf/odb_report.hpp">ODB report</a>.</p>
<p>ODB is a library for Object Relational Mapping. In other words, we use it to serialize the class data of errors, so that the debugulator can deserialize the error details directly into variables and classes without parsing.</p>
<p>We use ODB mostly in <a href="../../../inc/vcf/error.hpp">inc/vcf/Error.hpp</a>, through some pragmas. The way ODB works is parsing the C++ classes that have ODB pragmas and outputs C++ code that serializes the class instance information into a SQL database. We chose Sqlite as database backend, which means that the DB reports can actually be opened with a Sqlite client.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
VCF assembly checker</h2>
<p>This program is much simpler than the validator. It's mostly about getting the reference sequence from a FASTA file and comparing it to the REF allele of each line in a VCF.</p>
<p>This is done in <a href="../../../inc/vcf/assembly_checker.hpp">inc/vcf/assembly_checker.hpp</a> and its implementation file <a href="../../../src/vcf/assembly_checker.cpp">src/vcf/assembly_checker.cpp</a>, with the help of some FASTA utilities in <a href="../../../inc/fasta">inc/fasta/</a>.</p>
<p>There are 3 ways to retrieve FASTA files:</p>
<ul>
<li>The user provides a file.</li>
<li>The VCF contains a <code>##reference</code> which we use to download a FASTA from ENA.</li>
<li>The VCF contains <code>##contig</code> entries and we use those contig accessions to download individual sequences.</li>
</ul>
<p>There's also limited support to use assembly reports (<a href="../../../inc/assembly_report/assembly_report.hpp">inc/assembly_report/assembly_report.hpp</a>) and translate between synonym contig names/accessions in case the nomenclature in the VCF and in the FASTA don't match.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
VCF Debugulator</h2>
<p>At the beginning of the project we expected there would be interesting situations were we could use the ODB report to fix automatically wrong VCFs. Sadly, it turned out that there's not much an automated program can do, really.</p>
<p>The fixes are implemented in <a href="../../../inc/vcf/fixer.hpp">inc/vcf/fixer.hpp</a> and <a href="../../../src/vcf/fixer.cpp">src/vcf/fixer.cpp</a>, and basically consist on removing duplicate variants and dropping entire fields that are non-conforming with the spec.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Testing</h1>
<p>Testing is performed with <a href="https://github.com/catchorg/Catch2">Catch</a> in the <a href="../../../test/"><code>test/</code></a> folder. The folders test/vcf/, test/fasta/ and test/assembly_report/ contain test source code, and test/input_files contain a medium-sized set of correct and wrong VCFs that are used in the tests. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
